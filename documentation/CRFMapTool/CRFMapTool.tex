\documentclass[12pt]{article}
\usepackage[table]{xcolor}
\definecolor{lightgray}{gray}{0.9}
\usepackage{fullpage}
\usepackage{graphics}
\usepackage[latin1]{inputenc}
\usepackage{enumerate} 
\usepackage{booktabs}  
\usepackage {graphicx}
\usepackage{seqsplit}
\usepackage{listings}
\usepackage[ngerman]{babel}
\usepackage{color}
\usepackage{url} \usepackage{tikz}
\usepackage[ruled,vlined,linesnumbered]{algorithm2e}
\usepackage{float}
\usepackage{longtable}
\let\oldlongtable\longtable
\let\endoldlongtable\endlongtable
\renewenvironment{longtable}{\rowcolors{2}{white}{lightgray}\oldlongtable} {
\endoldlongtable}
\usepackage{txfonts}
\usepackage {multirow}
\urlstyle{rm}
\begin{document}


\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}

\title{Praktikum - CRF Mapping Tool}
\author{Victor Christen} 
\begin{titlepage}
\begin{center}
% Upper part of the page
\textsc{\LARGE Universität Leipzig}\\[0.3cm]

{ Institut für Medizinische Informatik, Statistik und Epidemiologie (IMISE)}\\[4cm]


% Title
\HRule \\[0.4cm]
{ \huge Realisierung eines CRF Versionen Mapping Tool}\\[0.4cm]

\HRule \\[1.5cm]
\vfill

% Bottom of the page
\begin{minipage} {0.4\textwidth}
	 \begin{flushleft}
	 {Leipzig, \today
	 }
	 \end{flushleft}
\end{minipage}
\begin{minipage}{0.5\textwidth}
\begin{flushright}
vorgelegt von:\\
Victor Christen\\
Betreuer:\\
Matthias Löbe\end{flushright}
\end{minipage}
\end{center}


\end{titlepage}
\tableofcontents
\newpage
\section{Einleitung}
\subsection{Motivation}
Die Resultate einer Studie basieren auf der Auswertung der in jeder Phase erfassten Daten bzlg. eines Patienten oder Probanden. Diese Daten werden mittels eines CRF (Check Report Form) Bogen erfasst. Diesbezüglich enthält ein solcher Bogen eine Menge von Datenfeldern(Items), die für die spätere Auswertung relevant sind.
Zu Beginn einer jeden Studie, werden deshalb für jede Phase einer Studie die relevanten Items inklusive ihrer Eigenschaften, Regeln und inhaltlichen Strukturierung ermittelt. Die Menge an CRF Bögen für die verschiedenen Studien können in einem klinischen Datenmanagmentsystem verwaltet werden, wie z.B. OpenClinica. Im Allgemeinen ist die Entwicklung eines CRF Bogens ein fortlaufender Prozeß, da im Verlauf der Studie fehlende oder unzureichend definierte Items identifiziert werden. Diese müssen in einer aktualisierten Version ergänzt bzw. geändert werden. Sei nun folgendes Szenario gegeben: Es wurden mittels eines CRF Bogens die relevanten Daten für die Phase der Aufnahme eines Patienten erfasst. Es wurde festgestellt, dass die Auswertung der Daten umständlich ist, so dass eine Anpassung des CRF Bogens erfolgen muss. Dennoch sollen die erfassten Daten weiter verwendet werden. Hierfür ist ein Mapping, eine Abbildung der alten Items auf die neuen Items, notwendig, um die alten Daten in das Schema des neuen CRF Bogens zu transformieren. Des Weiteren ist es für die Weiterentwicklung eines CRF Bogens hilfreich zu wissen, welche Items bisher geändert wurden, so dass eine gezielte Entwicklung fortgeführt werden kann. Da ein CRF Bogen potentiell eine hohe Anzahl an Datenfeldern beinhaltet und mehrere Versionen umfasst, ist eine manuelle Generierung eines Mappings für alle Versionen nicht effizient realisierbar. Eine weitere Problematik bzgl. der Änderungen von Items  ist die Relevanz der Änderung. Die Änderungen von Eigenschaften eines Items,die sich auf das Layout bzgl. des CRF Bogens beschränken, verursachen keine Änderung des medizinischen Konzepts, sodass existierende Daten auf das neue Item gemappt werden können. Die Transformation der Daten eines Items, deren medizinisches Konzept sich geändert hat, ist nicht ohne weiteres möglich. \\
\subsection {Zielsetzung}
Das Ziel dieser Arbeit ist die Entwicklung einer Applikation für die Generierung eines Mappings für eine Menge von CRF Versionen und eine entsprechende Visualisierung, sodass eine effiziente Identifikation der Änderungen und deren Ursache möglich ist. Ein Mapping repräsentiert eine Abbildung von Items,die eine effiziente Identifikation von gelöschten, hinzugefügten und geänderten Items ermöglicht.\\
Des Weiteren werden die geänderten Items bzgl. der Relevanz der Änderung klassifiziert, sodass eine Filterung bzgl. der Art der Änderung möglich ist.
\section{Grundlagen}
\subsection{CRF Excel Spezifikation}
Der Import eines CRF Bogens in das OpenClinica System erfolgt durch eine Excel Datei, die die enthaltenden Datenfelder mit ihren Eigenschaften, Abschnitten und potentiellen Regeln für die Items in Form von einzelnen Tabellen enthält. Das Schema der Excel Mappe entspricht dem Klassendiagramm in Abbildung \ref{fig:CRFExSchema}. \\
\begin{figure}[th]%
\input{figures/CRFClasses}
\caption{Datenschema der Excel Arbeitsmappe für einen CRF Bogen}%
\label{fig:CRFExSchema}%
\end{figure}
Die Klassen entsprechen den einzelnen Tabellen und die Attribute einer Klasse repräsentieren die Spalten der Tabelle. Die \texttt{CRF} Tabelle beinhaltet Informationen bzgl. des Namens des CRF Bogens, der Version, einer Beschreibung sowie Bemerkungen bzgl. der Erstellung.\\
Die \texttt{Sections} Tabelle definiert die layoutspezifische Struktur der Items des CRF's. Items, die das gleiche \texttt{section\_label} Attribut aufweisen, werden auf der gleichen Seite aufgeführt. Jede Section wird durch das \texttt{section\_label} Attribut identifiziert. Visuell wird jeder Abschnitt durch eine Überschrift getrennt, die durch den \texttt{section\_title} spezifiziert wird.\\
Die \texttt{Groups} Tabelle ermöglicht die Gruppierung von Items. Items, die das gleiche \texttt{group\_label} besitzen, erscheinen zusammen im CRF.
Die Daten, die für die Auswertung notwendig sind, werden durch die Items eines CRF Bogens definiert. Die Spezifikation eines Items beinhaltet die Eigenschaften die in der Tabelle \ref{table:Items} aufgelistet sind.
\input{figures/itemdescr}%
\section{Realisierung}
Die Applikation ist in Java implementiert und verwendet für das Auslesen der Excel Dateien die Apache POI \footnote{http://poi.apache.org/} Bibliothek. \\
Der Unterabschnitt \ref{sec:schema} beschreibt das zugrundeliegende Datenschema der Applikation. Im Unterabschnitt \ref{sec:workflow} wird der prinzipielle Ablauf der Applikation beschrieben. Abschließend wird detailliert auf die Berechnung der Unterschiede bzgl. einer Menge von CRF Versionen eingegangen. 

\subsection{Datenschema}\label{sec:schema}
Um einer potentiellen Veränderung der Excel Datei Spezifikation entgegenzuwirken, wurde ein eigenes generisches Datenschema für eine CRF Version konzipiert. Das Schema ist in Abbildung \ref{fig:CustomSchema} dargestellt.\\
Die \texttt{CRFVersion} Klasse aggregiert die \texttt{Sections}, \texttt{Groups} und \texttt{Items} Tabelle in Form einer Hashmap mit dem jeweiligen \texttt{label} Attribut als Schlüssel und dem dazugehörigen Objekt der Klasse \texttt{Section}, \texttt{Group} bzw. \texttt {Item} als Wert. Die Klassen \texttt{Section}, \texttt{Group} und \texttt{Item} sind prinzipiell gleich aufgebaut. Als Identifier besitzen sie ein \texttt{(item|section|group)\_label} Attribut und eine Hashmap \texttt{propertyMap}, die die Werte aller Spalten einer \texttt{Section}, einer \texttt{Group}, bzw. eines \texttt{Item} beinhaltet. Die Namen der Spalten fungieren als Schlüssel für die \texttt{propertyMap} und werden in der jeweiligen \texttt{(Item|Section|Group)Constants} Klasse gespeichert. Somit ist durch die lose Koppelung der Spalten zu einem Objekt mittels der \texttt{propertyMap} und der Konstanten, eine Veränderung der CRF Excelspezifikation trivial realisierbar.
\begin{figure}[ht!]
\input{figures/CustomClasses}%
\caption{Klassendiagramm für eine CRFVersion}%
\label{fig:CustomSchema}%
\end{figure}  
\newpage
\subsection{Allgemeiner Ablauf} \label{sec:workflow}
Der allgemeine Ablauf der Applikationslogik ist in Abbildung \ref{fig:workflow} dargestellt. Zu Beginn spezifiziert der Anwender eine Menge von CRF Versionen. Die Dateien werden mittels der POI Bibliothek ausgelesen und zu Objekten des eigenen Datenschemas transformiert. Anschließend werden iterativ die Änderungen der CRF Versionen ermittelt und die Änderungen nach ihrer Relevanz klassifiziert. Bei jeder Iteration werden zwei aufeinander folgend Versionen miteinander verglichen und in der nächsten Iteration werden die alte zweite und die darauffolgende Version miteinander verglichen. Des Weiteren werden in jeder Iteration die Änderungen der Eigenschaften der Items bzlg. der Intensität ihres Ausmaßes klassifiziert. Die Änderungen werden in Form eines Baumes visualisiert, indem die aktuelle Version als Bezugspunkt für alle Änderungen der CRF Versionen dient.
\begin{figure}[t]
\center
\input{figures/workflow}
\caption{Workflow der Applikation}%
\label{fig:workflow}%
\end{figure}
\subsection{Diff-Berechnung}
Die Menge der Änderungsoperationen wird als Diff bezeichnet. Die Ermittlung des Diff für eine Menge von CRF Versionen basiert auf dem fortlaufenden Vergleich von zwei CRF Versionen. Im Folgenden wird das Verfahren für die Ermittlung näher beschrieben.\\
Die Eingabe der Methode sind zwei CRF Versionen. Das Ergebnis ist eine Menge von gleichen, gelöschten, hinzugefügten und geänderten Items. Die geänderten Items werden als Mapping von altem Item zu neuem Item repräsentiert. Des Weiteren wird für jedes Mapping die Menge der geänderten Eigenschaften sowie der alte und der neue Wert gespeichert. Das Vorgehen ist im Algorithmus \ref{alg:diff} dargestellt. Jedes Item der alten Version wird mit jedem Item der neuen Version verglichen, indem die \texttt{item\_labels} und die\texttt{propertyMap} Objekte verglichen werden (Zeile 3). Wenn diese gleich sind, sind die Items gleich und ein Repräsentant wird zu der Menge $eqItemSet$, die die Menge der gleichen Items repräsentiert, hinzugefügt (Zeile 4). Wenn keine Gleichheit besteht, ist das item der alten Version gelöscht(Zeile 5-8) bzw. ist das Item der neuen Version hinzugefügt (Zeile 9-12). Da geänderte Items sich durch einen anderen Suffix beim \texttt{item\_label} unterscheiden, befinden sich in den Mengen $delItemSet$ und $addItemSet$ eventuell geänderte Items. Um die Menge der geänderten Items zu ermitteln, wird mithilfe eines Fuzzy- Matchers die Ähnlichkeit für jedes Item der $delItemSet$ Menge und jedem Item der $addItemSet$ Menge bestimmt (Zeile 13-23). Der Fuzzy- Matcher verwendet für die Berechnung der Ähnlichkeit eine Kombination der Editierdistanz für die \texttt{item\_labels} und die \texttt{description\_labels}. Als geändertes Item wird das Paar angesehen, dessen Ähnlichkeit größer als ein Threshold $\delta(0.6)$ ist und das die höchste Ähnlichkeit aufweist. Anschließend wird für jedes Paar die Menge der geänderten Eigenschaften, die die Spalten repräsentieren, ermittelt. \\
Diese Methode wird iterativ für die nächsten beiden Versionen fortgeführt, wobei die aktuelle neue Version, die alte Version ist und die darauffolgende die neue. Die Berechnung des Diff's ist abgeschlossen, wenn alle Versionen verarbeitet sind.
\begin{algorithm}[t!] \label{alg:diff}
\caption{Diff Berechnung für zwei CRF Versionen}
\DontPrintSemicolon
\SetKwData{io}{$oldItem$} \SetKwData{iN}{$newItem$} \SetKwData{ai}{$addItem$} \SetKwData{di}{$delItem$} 
\SetKwData{op}{$oldPropertySet$} \SetKwData {np} {$newPropertySet$}
\SetKwData{vo}{$oldVersion$} \SetKwData{vn}{$newVersion$} \SetKwData {eqI} {$eqItemSet$} \SetKwData {addI} {$addItemSet$}
\SetKwData {delI} {$delItemSet$} \SetKwData {modI} {$modItemMap$} \SetKwData{propMap}{$propertyMap$}
\SetKwInOut{Input}{input}\SetKwInOut{Output}{output}
\Input {\vo , \vn}
\Output {\eqI, \addI, \delI, \modI, \propMap}
\For {\io $\in$ \vo}{
	\For {\iN $\in$ \vn}{
		\If{ \io.equals(\iN)}{
			\eqI $\leftarrow$ \eqI $\cup$\iN\; 
		}
		
	}
}

\For {\io $\in$ \vo}{
	\For {$equalItem \in$ \eqI }
		{
			\If{\io.$item\_label$!=$equalItem.item\_label$}{
					\delI$\leftarrow$ \delI $\cup$ \io\;
			}
		
		
		}
	}
	
	\For {\iN $\in$ \vn}{
	\For {$equalItem \in$ \eqI }
		{
			\If{\iN.$item\_label$!=$equalItem.item\_label$}{
					\delI$\leftarrow$ \delI $\cup$ \iN\;
			}
		}
	}



\For {\ai $\in$ \addI}{
	$topMapping \leftarrow \emptyset$ \;
	\For {\di $\in$ \delI}{
		$similarity = fuzzyMatch(\ai,\di)$ \;
		
		\If{$similarity \geq \delta$}{
			$topMapping \leftarrow add(similarity,(\di,\ai))$
		}
			
		\If{$topMapping \neq \emptyset$}{
			(\di,\ai) = bestMapping($topMapping$)\;
			\modI $\leftarrow$ add(\di,\ai)\;
			\addI = \addI $\backslash$ \{ \ai \}\;
			\delI = \delI $\backslash$ \{ \di \} \;
			}
	}
}

\For {$ (\io,\iN) \in  \modI$}{
	\op = \io.properties\;
	\np = \iN.properties\;
	$modProperties$ = diff(\op,\np)\;
	\propMap $\leftarrow$ add(modProperties)\;
}
\end{algorithm}
\clearpage
\subsection{Klassifikation}
 Um die Auswirkungen der geänderten Datenfelder abzuschätzen, ist eine Einordnung dieser nach spezifizierten Kategorien erforderlich.
 Die Kategorien sind vordefiniert und orientieren sich an der möglichen Ausprägung der Semantik eines Items. Es existieren folgende Klassen:

 \begin{itemize}
 \item \emph{semantic} \\
 Diese Kategorie umfasst Änderungen, die durch die Modifikation der Beschreibung, der Header oder der linken bzw. rechten Textlabels hervor gerufen werden. Es wird angenommen, dass eine solche Änderung eine Veränderung des semantischen Konzepts als Ursache hat.
  \item \emph{semantic specialization}\\
  Diese Kategorie ist eine Erweiterung der \emph{semantic} Kategorie. Wenn der Inhalt durch einen Suffix erweitert wurde, wird angenommen, dass es sich um eine Spezialisierung handelt.
  \item \emph{response range}\\
  Diese Kategorie repräsentiert alle Änderungen, die einen Einfluss auf die Spezifikation der möglichen Antworten des Datenfelds haben.\\
   Die Eigenschaften, die davon betroffen sind:\\
   DATA\_TYPE, DEFAULT\_VALUE, RESPONSE\_LABEL, RESPONSE\_OPTIONS\_TEXT, RESPONSE\_TYPE,REQUIRED, RESPONSE\_VALUES\_OR\_CALCULATIONS und UNITS.
  
  \item \emph {item interrelation}\\
   Eine Änderungen, die die Beziehung bzgl. eines anderen Items ändert, wird zu dieser Kategorie zugeordnet.\\
   Die Eigenschaften, die davon betroffen sind:\\
   GROUP\_LABEL und PARENT\_ITEM.
  \item \emph {validation}\\
  Diese Kategorie umfasst alle spezifizierenden Eigenschaften, die die Validierung der Daten festlegen oder Sicherheitseinstellungen bzgl der Sichtbarkeit der Daten spezifizieren.\\
  Die Eigenschaften, die davon betroffen sind:\\
  VALIDATION, VALIDATION\_ERROR\_MESSAGE und PHI.
  
  \item \emph {small editing}\\
  Die Änderungen, die keinen Einfluss auf die Eigenschaft haben, sondern lediglich eine Korrektur oder eine andere Codierung realisieren, werden dieser Kategorie zugeordnet. 
  
	\item \emph{layout}\\
	Diese Kategorie beinhaltet alle Änderungen, die sich auf die Anordnung und die Strukturierung der Datenfelder beziehen.
	Die Eigenschaften, die davon betroffen sind:\\
	
\end{itemize} 
\section{Funktionsweise}
Die Applikation besitzt drei basale Funktionalitäten, die Spezifikation der CRF Versionen, die Betrachtung der einzelnen CRF Versionen und die Betrachtung der Unterschiede der CRF Versionen im Bezug auf die aktuelle Version.\\
Die Spezifikation der CRF Version erfolgt im Menü File/Open. Für die Betrachtung der Unterschiede müssen mindestens zwei Versionen eines CRF Bogens selektiert werden.\\
Der Anwender ist in der Lage sich die einzelnen CRF Versionen einzeln zu betrachten (siehe Abb. \ref{fig:crfView}), indem er eine Version in der ComboBox selektiert und hinzufügt. Die selektierte Version wird als Baum, deren Blätter die Items repräsentieren, auf der linken Seite der Applikation dargestellt. Bei der Selektion eines Items können die Eigenschaften im unteren Teil der Anwendung betrachtet werden.\\
\begin{figure}[ht]%
\includegraphics[width=\columnwidth]{figures/crfView.pdf}%
\caption{Darstellung der Items einer CRF Version in einem Baum inklusive der Ansicht der Eigenschaften eines Items in einer Tabelle}%
\label{fig:crfView}%
\end{figure}
Die Änderungen werden auf der rechten Seite des Programms (siehe Abb. \ref{fig:diffView}). Die Items der aktuellen Version werden in einem Baum dargestellt. Die geänderten Items werden farblich hervor gehoben. Des Weiteren werden alle Änderungen die ein Item betreffen chronologisch in einer Tabelle als Blattknoten des betreffenden Items dargestellt. Die Tabelle enthält die Versionsnummer von der vorherigen Version, den Namen des alten Items und die Art der Änderung. Bei der Selektion eines Eintrages der Tabelle, werden die geänderten Eigenschaften im unteren Teil in einer Tabelle präsentiert. Diese Tabelle enthält den Namen der geänderten Eigenschaft, den alten und neuen Wert und die Kategorie der Änderung. Der Anwender ist in der Lage die geänderten Items nach der Kategorie der Änderung zu filtern, indem er im category selection Menü die jeweiligen Kategorien selektiert. Des Weiteren werden die gelöschten Items in einer separaten Tabelle chronologisch nach ihrem Löschzeitpunkt präsentiert, da diese in der aktuellen Version nicht vorhanden sind.
\begin{figure}[htb]%
\center
\includegraphics[width=\columnwidth]{figures/diffView.pdf}%
\caption{Darstellung der Änderung der geänderten Items und der geänderten Eigenschaften}%
\label{fig:diffView}%
\end{figure}

\section{Zusammenfassung}
\end{document}
